## 如何拆分（抽象）组件
### 问题背景
组件化开发已经是当前前端达成的共识，那么在实际开发基础组件、业务组件的时候，针对于实际场景，该去如何拆分、如何去抽象我们的组件，则变得十分重要。

### 组件拆分的种类
常用的组件，可按层级和功能两个维度，划分成不同类型的组件。
![image](https://raw.githubusercontent.com/hu0950/material-management/master/topic/component/type.png)

**1. 按层级划分**

  - **基础组件**

    主要指组件本身**不包含任何业务逻辑，可被轻松复用的组件**。
    
    常见的模式是基于特定的前端框架（Vue、React等）实现一套通用的基础组件库，如Cube-UI、ElementUI等。在这类组件库中，通常会包括很多可复用于不同场景中的基础组件，例如：Tip、Picker、Toast、Dialog等。

    这类组件在设计时，主要考虑对外暴露的prop、event等数据通讯、使用方式、样式等如何定义，以及组件与外部的交互形态，功能边界的划分等
    
  - **通用组件**

    主要指**含有业务逻辑，但在一定范围内是通用**的组件。一般来说，该类组件，可根据复用的频率，沉淀在业务组件库中，也可以是抽象在项目公共部分中。

    在日常项目开发中，举个例子，在司机/乘客业务中，通常都会有城市选择的功能。针对该场景，可抽象出一个通用的城市选择组件，包含获取城市数据，提供用户可进行城市选择，以及统一的异常错误处理等逻辑。当我们需要进行城市选择时，可以直接使用，而无需多次重复实现。

  - **业务组件**

    主要指**与特定的业务场景耦合得更紧密**的组件，另外，也会包括一些与后端接口通讯的逻辑。

    该类组件因视觉规范、交互风格、业务场景等的差异性，在大部分的情况下，只在一个业务场景下通用。因此，会根据不同的业务方向，沉淀不同的业务组件库。例如：团队中按业务划分的司机运营方向和组织化方向，会分别沉淀两套组件库。业务开发中，例如：司机运营方向的H5页面，一般是在司机端中投放，直接调用司机端bridge功能进行拍照的逻辑，会统一封装进去。  
  
**2. 按功能划分**

  - **简单组件**

    这类组件，通常具有**只有输入(props)，一般弱交互、无状态**的特点。
    
    抽象该类组件的目的，主要是为了可以在不同场景中，**实现样式的复用**。
    
    常见的场景，例如：

    a. 纯渲染，用于展示 - 卡片组件
    ![image](https://raw.githubusercontent.com/hu0950/material-management/master/topic/component/card.png)

    b. 纯布局，用于布局样式 - N*N布局
    ![image](https://raw.githubusercontent.com/hu0950/material-management/master/topic/component/N*N.png)
  
  - **复杂组件**
  
    这类组件，通常**具有较多的状态逻辑和事件交互**的特点。这些交互处理，通常会包括控制子组件的状态，以及接收子组件抛出的事件，来分别控制交互行为。

    往往复用程度较高的组件，都会采用**配置模式**和**组合模式**的思想来进行设计。

    组合模式的应用，例如：表单组件，通常会拆分成form-group和form-item，把彼此组合在一起，才能提供一个表单组件应有的完整能力。
    配置模式的应用，例如：熟悉的表单配置化的场景，在约定好固有的数据格式以及配置规范的前提下，根据传入不同的prop做相应的数据渲染，以及提供各种具名插槽，外部通过配置，从而决定组件的最终形态。

**3. 组件的类型组合**

  通过对两个维度进行组合，归纳出以下几种组件类型：
  
  **a. 简单基础类型**：和具体业务逻辑无关，本身的实现也比较简单。常见的组件有：icon、toast、button等。

  **b. 复杂基础类型**：和具体的业务逻辑无关，本身的每个实现较复杂，和外部的交互比较多。常见的组件有：轮播、索引列表、上拉下拉等。

  **c. 简单业务类型**：对简单的业务场景进行抽象。常见的组件有：车型抽屉、城市组件等。

  **d. 复杂业务类型**：对复杂的业务场景进行抽象。常见的组件有：问卷组件、APP等。

> **复杂的组件可通过组合简单的组件**而得到，以实现1+1>2的效果。

下面以**轮播组件、日历组件**的例子抛砖引玉，来看看如何通过组合的方式，来基于简单的组件，拓展成复杂功能的组件？
- **轮播组件**：基本的轮播组件，只提供可轮播的核心功能即可，而轮播的内容，可通过组件提供的slot插入，以此实现图片轮播、视频轮播等不同功能的轮播组件。
- **日历组件**：日历组件，可拆分为两部分进行实现，一是日历的基础功能，只提供日期渲染、日期选择等能力，二是控制日历出现/收起方式的相关的modal组件。采用组合方式的好处是：日历本身的核心逻辑和交互方式的逻辑是解耦的，在无需改动核心逻辑的前提下，就可以很轻易的组合出：从上向下弹出和从下向上弹出等多种交互方式的日历组件，也方便日后的拓展。

从上向下弹出：
  ![image](https://raw.githubusercontent.com/hu0950/material-management/master/topic/component/carlendar.png)

从下向上弹出：
  ![image](https://raw.githubusercontent.com/hu0950/material-management/master/topic/component/carlendar2.png)

### 组件拆分
项目中常见的方式，通常会在app.vue中通过路由，映射到不同组件，因此，这里会从入口组件，即页面组件开始探讨。

**1. 页面组件（page）**

这类组件一般是**按页面进行划分**，主要的职责通常是：处理页面跳转、获取接口请求、处理各区块组件所需的数据等相关逻辑。

这里探讨一个特殊的场景：**当有N个复用性很高的页面，是否要考虑共用一个页面组件？**
如果有这N个页面是可互相跳转的，或是在将来页面的UI还有可能发生改变，不考虑共用，而是考虑复用页面中的共用组件即可。

**2. 区块组件（component）**

该类组件主要是：按功能（展示区域）的独立性进行拆分、按页面的可见区域折叠拆分（初始时不可见，以及需要异步加载）、按条件加载的部分。

一般情况，一个页面组件会拆分成多个区块组件，这里我们需要思考，考虑拆分组件的目的，是复用还是分治。如果是基于分治的目的，可以将业务逻辑（请求接口、数据处理的相关逻辑）放在拆分的组件中；如果是基于复用的目的，可以保持该组件是无状态，只给该组件传入处理好的数据，组件本身只负责根据已经处理好的数据渲染即可。

**3. 业务组件（业务组件库）**

一般按项目的性质，从交互、UI风格以及基础业务功能等角度，封装或选择已有的适合该项目的业务组件库进行使用。

**4. 基础组件（基础组件库）**

这类组件通常会提供一些基础组件，也可以在此基础上，增加业务定制的功能，进行拓展，沉淀出适合业务场景的业务组件。

### 拆分组件的目的
**1. 提供复用性**

无论是以上所提及到的基础组件，还是业务组件，都是只封装共性行为，并暴露各种API、事件交互等，使之可用于多种场景中，实现其复用的价值。

**2. 功能逻辑分治**
  
当页面/组件的功能，过于复杂时，所有的功能都在一个组件中编写，代码量大，不易于阅读，后期维护的成本也会很高，不易于修改。基于这种场景下，可将代码按照功能的相对独立性，进行拆分，从而达到功能逻辑分治的目的，减少不同功能逻辑的耦合，降低当前组件复杂度，逻辑结构可变得更清晰，利于排错。

**如何拆分页面的处理逻辑，实现分治？**
总体的思路：**整体到局部，一般根据产品模块以及UI设计，划分为独立块**。
接下来，将用一个页面举例说明，应该思考从整体到局部，如何对一个组件的逻辑的拆分？

例如：业务开发中常见的页面，其实是按照产品拆分为不同的页面组件，放在view中。在同一个页面中，也会有不同的块，以下图为例，可以直观的拆分出三个大卡片的部分，分别是：活动状态提示部分、活动进度展示部分、奖项设置部分，其中，中间卡片部分（活动进度部分）还可细拆分出step1和step2部分。在所拆分的组件部分中，可以专注处理该部分在不同状态下的渲染或是相关业务逻辑。
![image](https://raw.githubusercontent.com/hu0950/material-management/master/topic/component/pk.png)

**3. 实现配置化**
配置化的实现，最重要的一方面是要对页面中内容进行抽象和归类，另外一方面是数据格式的约定。

以答疑工具项目为例，用户需要根据选择相应的问题类型，进行提问，该场景具有问题的种类多，但问题分类虽不同，但填写问题模板页面（如下图）相似的特点，其中相似性体现在于，构成不同的问题模板页面的组件是相同的，但组件的组合不同。此外，为了能更好地在后期新增问题种类的同时，可以快速的支持开发上线。可将问题模板页面实现成可配置化的，以此实现对不同种类的问题模板配置不同的问题类表单组件。
![image](https://raw.githubusercontent.com/hu0950/material-management/master/topic/component/question-template.png)
配置化设计思路如下：
![image](https://raw.githubusercontent.com/hu0950/material-management/master/topic/component/question.png)
经配置化所得到的这个问题模板，不仅适用于创建问题页面，还可复用于其它场景，如升级问题、答复问题等都是由不同的问题类表单组件构成的页面。

### 组件评估
通常我们可以从以下几个角度来评估组件是否需要拆分，以及拆分的合理性。

**1. 300行原则**

  当一个组件文件代码行数过多的时候，这个组件内部可能承担了太多的处理逻辑。同时从代码也不利于阅读和修改，对后期维护也是一个大的负担。为此，我们可以从逻辑分治的原则触发，尽量减少单个组件中，分治不同功能的逻辑。

**2. 单一职责原则**

  组件拆分遵循单一职责原则，一个组件负责一个具体的职责，便于管理和维护。
    
**3. 复用原则**

  当系统（应用）里很多地方具有同样的功能和逻辑时，就可以进行组件拆分，这样一个组件在多处重复使用，就可以达到复用的效果。

**4. 组合原则**

参见上面组合在一起部分。

**5. API规范**

组件提供出来的API是否符合规范，例如 props、事件、甚至也包含 class 命名等。

**6. 单测**

通过思考如何要为这个组件写单测试case来判断，如果可以很方便的通过各种单测case（即使不是真的写了单测）就能很好的覆盖这个组件的各种功能，这个时候我们就可以认为这个组件写的是OK的，大概率是基本符合上边的这些原则的；反过来，如果写单测case很难，各种副作用在里边，那这个时候可能就需要重新考虑下这个组件的拆分抽象是否是合理的。